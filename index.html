<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portal Administrativo - Guarda Municipal</title>
<style>
/* Mantive todo o CSS que você já tinha */
...
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="login-container">
  <div class="login-box">
    <div class="login-header">
      <h1>🛡️ Portal Administrativo</h1>
      <p>Guarda Municipal - Sistema de Gestão</p>
    </div>
    <div id="loginError" class="error-msg"></div>
    <form id="loginForm">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="username" placeholder="Digite seu email" required>
      </div>
      <div class="form-group">
        <label>Senha</label>
        <input type="password" id="password" placeholder="Digite sua senha" required>
      </div>
      <button type="submit" class="btn">Entrar</button>
    </form>
    <p style="text-align:center; margin-top:20px; color:#999; font-size:13px;">
      Primeiro acesso? Use suas credenciais fornecidas pela administração
    </p>
  </div>
</div>

<!-- MODAL EMAIL -->
<div id="emailModal" class="modal">
  <div class="modal-content">
    <h2>Bem-vindo! 👋</h2>
    <p>Para receber notificações, cadastre seu email:</p>
    <form id="emailForm">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="userEmail" placeholder="seu.email@exemplo.com" required>
      </div>
      <button type="submit" class="btn">Confirmar</button>
    </form>
  </div>
</div>

<!-- SISTEMA PRINCIPAL -->
<div id="mainSystem" class="main-container">
  <div class="header">
    <div><h1>🛡️ Portal Administrativo GM</h1></div>
    <div class="user-info">
      <span class="badge" id="userBadge"></span>
      <span class="badge badge-admin" id="adminBadge" style="display:none;">ADMINISTRADOR</span>
      <button class="btn-logout" onclick="logout()">Sair</button>
    </div>
  </div>

  <div class="nav-tabs">
    <button class="tab-btn active" onclick="showTab('comunicados')">📢 Comunicados</button>
    <button class="tab-btn" onclick="showTab('escalas')">📅 Escalas</button>
    <button class="tab-btn" onclick="showTab('operacoes')">🚨 Operações</button>
    <button class="tab-btn" onclick="showTab('documentos')">📁 Documentos</button>
  </div>

  <!-- Conteúdos (copiado igual ao seu HTML) -->
  <div id="comunicados" class="content-section active">...</div>
  <div id="escalas" class="content-section">...</div>
  <div id="operacoes" class="content-section">...</div>
  <div id="documentos" class="content-section">...</div>
</div>

<script type="module">
  // 🔹 Firebase Config
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBVfCbAucFErELqatHP1DgJsAweMR_rzJo",
    authDomain: "sistema-gm-145eb.firebaseapp.com",
    projectId: "sistema-gm-145eb",
    storageBucket: "sistema-gm-145eb.firebasestorage.app",
    messagingSenderId: "1033769343247",
    appId: "1:1033769343247:web:24d6934babf8a4eb65867a"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getFirestore();

  let currentUser = null;
  let isAdmin = false;

  // LOGIN
  document.getElementById('loginForm').addEventListener('submit', async e => {
    e.preventDefault();
    const email = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      currentUser = userCredential.user;
      const tokenResult = await currentUser.getIdTokenResult();
      isAdmin = tokenResult.claims.admin || false;

      // Se for o primeiro acesso, abrir modal de email
      if(!currentUser.emailVerified){
        document.getElementById('emailModal').style.display='flex';
      } else {
        showMainSystem();
      }
    } catch(err) {
      const errorMsg = document.getElementById('loginError');
      errorMsg.textContent = '❌ Usuário ou senha incorretos';
      errorMsg.style.display = 'block';
    }
  });

  // CADASTRO EMAIL
  document.getElementById('emailForm').addEventListener('submit', async e => {
    e.preventDefault();
    const email = document.getElementById('userEmail').value;
    await currentUser.updateEmail(email);
    document.getElementById('emailModal').style.display='none';
    showMainSystem();
  });

  // MOSTRAR SISTEMA
  function showMainSystem(){
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('mainSystem').style.display='block';
    document.getElementById('userBadge').textContent=currentUser.email;

    if(isAdmin){
      document.getElementById('adminBadge').style.display='inline-block';
      document.querySelectorAll('.admin-only').forEach(el=>el.style.display='block');
    }

    loadComunicados();
  }

  function logout(){
    auth.signOut();
    currentUser = null;
    document.getElementById('loginScreen').style.display='flex';
    document.getElementById('mainSystem').style.display='none';
    document.getElementById('loginForm').reset();
  }

  function showTab(tabId){
    document.querySelectorAll('.content-section').forEach(el=>el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el=>el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');
  }

  // FIRESTORE: ADICIONAR COMUNICADO
  async function addComunicado(e){
    e.preventDefault();
    const tipo = document.getElementById('tipoComunicado').value;
    const titulo = document.getElementById('tituloComunicado').value;
    const conteudo = document.getElementById('conteudoComunicado').value;

    await addDoc(collection(db, "comunicados"), {
      tipo, titulo, conteudo, autor: currentUser.email,
      data: new Date().toISOString()
    });

    alert('✅ Comunicado publicado! Notificações enviadas.');
    e.target.reset();
    loadComunicados();
  }

  async function loadComunicados(){
    const lista = document.getElementById('listaComunicados');
    const snapshot = await getDocs(collection(db, "comunicados"));
    lista.innerHTML = '';
    snapshot.forEach(doc => {
      const c = doc.data();
      const data = new Date(c.data).toLocaleString('pt-BR');
      lista.innerHTML += `
        <div class="item-box">
          <div class="item-header">
            <span class="item-tipo">${c.tipo}</span>
            <span class="item-data">${data}</span>
          </div>
          <div class="item-titulo">${c.titulo}</div>
          <div class="item-conteudo">${c.conteudo}</div>
          <div style="margin-top:10px; font-size:12px; color:#999;">Publicado por: ${c.autor}</div>
        </div>
      `;
    });
  }

</script>

</body>
</html>
