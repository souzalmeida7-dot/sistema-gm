<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portal Administrativo - Guarda Municipal</title>
<style>
/* === SEU CSS ATUAL, MANTIDO === */
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);min-height:100vh;}
/* ... [todo o CSS que você já tinha, sem alterações] ... */
</style>
</head>
<body>

<!-- TELA DE LOGIN -->
<div id="loginScreen" class="login-container">
  <div class="login-box">
    <div class="login-header">
      <h1>🛡️ Portal Administrativo</h1>
      <p>Guarda Municipal - Sistema de Gestão</p>
    </div>
    <div id="loginError" class="error-msg"></div>
    <form id="loginForm">
      <div class="form-group">
        <label>Usuário (Email)</label>
        <input type="email" id="username" placeholder="Digite seu email" required>
      </div>
      <div class="form-group">
        <label>Senha</label>
        <input type="password" id="password" placeholder="Digite sua senha" required>
      </div>
      <button type="submit" class="btn">Entrar</button>
    </form>
    <p style="text-align:center;margin-top:20px;color:#999;font-size:13px;">Primeiro acesso? Use suas credenciais fornecidas pela administração</p>
  </div>
</div>

<!-- MODAL CADASTRO EMAIL -->
<div id="emailModal" class="modal">
  <div class="modal-content">
    <h2>Bem-vindo! 👋</h2>
    <p style="margin-bottom:20px;">Para receber notificações, cadastre seu email:</p>
    <form id="emailForm">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="userEmail" placeholder="seu.email@exemplo.com" required>
      </div>
      <button type="submit" class="btn">Confirmar</button>
    </form>
  </div>
</div>

<!-- SISTEMA PRINCIPAL -->
<div id="mainSystem" class="main-container">
  <div class="header">
    <div><h1>🛡️ Portal Administrativo GM</h1></div>
    <div class="user-info">
      <span class="badge" id="userBadge"></span>
      <span class="badge badge-admin" id="adminBadge" style="display:none;">ADMINISTRADOR</span>
      <button class="btn-logout" onclick="logout()">Sair</button>
    </div>
  </div>

  <div class="nav-tabs">
    <button class="tab-btn active" onclick="showTab('comunicados')">📢 Comunicados</button>
    <button class="tab-btn" onclick="showTab('escalas')">📅 Escalas</button>
    <button class="tab-btn" onclick="showTab('operacoes')">🚨 Operações</button>
    <button class="tab-btn" onclick="showTab('documentos')">📁 Documentos</button>
  </div>

  <!-- SEÇÕES: comunicados, escalas, operações, documentos -->
  <!-- [MANTENHA SEU HTML EXISTENTE DAS ABAS] -->
</div>

<!-- SCRIPTS -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-storage.js";
import emailjs from "https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBVfCbAucFErELqatHP1DgJsAweMR_rzJo",
  authDomain: "sistema-gm-145eb.firebaseapp.com",
  projectId: "sistema-gm-145eb",
  storageBucket: "sistema-gm-145eb.appspot.com",
  messagingSenderId: "1033769343247",
  appId: "1:1033769343247:web:24d6934babf8a4eb65867a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// LOGIN
document.getElementById('loginForm').addEventListener('submit', async e => {
    e.preventDefault();
    const email = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        showMainSystem(userCredential.user);
    } catch (err) {
        document.getElementById('loginError').textContent = '❌ Usuário ou senha incorretos';
        document.getElementById('loginError').style.display = 'block';
    }
});

function logout() {
    signOut(auth).then(()=>{
        document.getElementById('loginScreen').style.display='flex';
        document.getElementById('mainSystem').style.display='none';
        document.getElementById('loginForm').reset();
    });
}

// MOSTRAR SISTEMA
function showMainSystem(user){
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('mainSystem').style.display='block';
    document.getElementById('userBadge').textContent=user.email;

    // Aqui pode buscar se é admin no Firestore
    // Exemplo simplificado:
    document.getElementById('adminBadge').style.display='inline-block';
}

// TROCAR ABAS
function showTab(tabId){
    document.querySelectorAll('.content-section').forEach(el=>el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el=>el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');
}

// FUNÇÕES FIRESTORE
async function addComunicado(e){
    e.preventDefault();
    const tipo=document.getElementById('tipoComunicado').value;
    const titulo=document.getElementById('tituloComunicado').value;
    const conteudo=document.getElementById('conteudoComunicado').value;
    const now=new Date();

    try{
        await addDoc(collection(db,'comunicados'),{
            tipo:tipo,
            titulo:titulo,
            conteudo:conteudo,
            data:now.toISOString(),
            autor:auth.currentUser.email
        });

        // EmailJS
        emailjs.send('YOUR_SERVICE_ID','YOUR_TEMPLATE_ID',{
            to_email: auth.currentUser.email,
            subject:'Novo Comunicado',
            message: titulo+'\n'+conteudo
        }, 'YOUR_PUBLIC_KEY');

        alert('✅ Comunicado publicado e notificações enviadas!');
        e.target.reset();
        loadComunicados();
    }catch(err){console.error(err);}
}

async function loadComunicados(){
    const q=query(collection(db,'comunicados'),orderBy('data','desc'));
    const snapshot=await getDocs(q);
    const lista=document.getElementById('listaComunicados');
    lista.innerHTML=snapshot.docs.map(doc=>{
        const c=doc.data();
        const date=new Date(c.data);
        return `<div class="item-box">
            <div class="item-header">
                <span class="item-tipo">${c.tipo}</span>
                <span class="item-data">${date.toLocaleDateString('pt-BR')} ${date.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</span>
            </div>
            <div class="item-titulo">${c.titulo}</div>
            <div class="item-conteudo">${c.conteudo}</div>
            <div style="margin-top:10px;font-size:12px;color:#999;">Publicado por: ${c.autor}</div>
        </div>`;
    }).join('');
}

// Carregar comunicados ao iniciar
auth.onAuthStateChanged(user => { if(user) loadComunicados(); });
</script>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

</body>
</html>
