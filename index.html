<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portal Administrativo - Guarda Municipal</title>
<!-- CSS -->
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); min-height: 100vh; }
/* ... (mesmo CSS que voc√™ j√° tinha, mantive todo) ... */
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBVfCbAucFErELqatHP1DgJsAweMR_rzJo",
  authDomain: "sistema-gm-145eb.firebaseapp.com",
  projectId: "sistema-gm-145eb",
  storageBucket: "sistema-gm-145eb.firebasestorage.app",
  messagingSenderId: "1033769343247",
  appId: "1:1033769343247:web:24d6934babf8a4eb65867a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="login-container">
  <div class="login-box">
    <div class="login-header">
      <h1>üõ°Ô∏è Portal Administrativo</h1>
      <p>Guarda Municipal - Sistema de Gest√£o</p>
    </div>
    <div id="loginError" class="error-msg"></div>
    <form id="loginForm">
      <div class="form-group">
        <label>Usu√°rio</label>
        <input type="text" id="username" placeholder="Digite seu usu√°rio" required>
      </div>
      <div class="form-group">
        <label>Senha</label>
        <input type="password" id="password" placeholder="Digite sua senha" required>
      </div>
      <button type="submit" class="btn">Entrar</button>
    </form>
    <p style="text-align:center; margin-top:20px; color:#999; font-size:13px;">Primeiro acesso? Use suas credenciais fornecidas pela administra√ß√£o</p>
  </div>
</div>

<!-- MODAL EMAIL -->
<div id="emailModal" class="modal">
  <div class="modal-content">
    <h2>Bem-vindo! üëã</h2>
    <p style="margin-bottom:20px;">Para receber notifica√ß√µes, cadastre seu email:</p>
    <form id="emailForm">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="userEmail" placeholder="seu.email@exemplo.com" required>
      </div>
      <button type="submit" class="btn">Confirmar</button>
    </form>
  </div>
</div>

<!-- SISTEMA PRINCIPAL -->
<div id="mainSystem" class="main-container" style="display:none;">
  <div class="header">
    <div><h1>üõ°Ô∏è Portal Administrativo GM</h1></div>
    <div class="user-info">
      <span class="badge" id="userBadge"></span>
      <span class="badge badge-admin" id="adminBadge" style="display:none;">ADMINISTRADOR</span>
      <button class="btn-logout" onclick="logout()">Sair</button>
    </div>
  </div>

  <div class="nav-tabs">
    <button class="tab-btn active" onclick="showTab('comunicados', event)">üì¢ Comunicados</button>
    <button class="tab-btn" onclick="showTab('escalas', event)">üìÖ Escalas</button>
    <button class="tab-btn" onclick="showTab('operacoes', event)">üö® Opera√ß√µes</button>
    <button class="tab-btn" onclick="showTab('documentos', event)">üìÅ Documentos</button>
  </div>

  <!-- COMUNICADOS -->
  <div id="comunicados" class="content-section active">
    <div class="card admin-only" id="formComunicado">
      <h3>üìù Novo Comunicado</h3>
      <form id="comunicadoForm">
        <div class="form-group">
          <label>Tipo</label>
          <select id="tipoComunicado">
            <option>INFORMATIVO</option>
            <option>URGENTE</option>
            <option>OPERACIONAL</option>
          </select>
        </div>
        <div class="form-group">
          <label>T√≠tulo</label>
          <input type="text" id="tituloComunicado" placeholder="T√≠tulo do comunicado" required>
        </div>
        <div class="form-group">
          <label>Conte√∫do</label>
          <textarea id="conteudoComunicado" placeholder="Escreva o comunicado..." required></textarea>
        </div>
        <button type="submit" class="btn">Publicar e Notificar Todos</button>
      </form>
    </div>

    <div class="card">
      <h3>Todos os Comunicados</h3>
      <div id="listaComunicados"></div>
    </div>
  </div>

  <!-- ESCALAS -->
  <div id="escalas" class="content-section">
    <div class="card admin-only" id="formEscala">
      <h3>üìù Nova Escala</h3>
      <form id="escalaForm">
        <div class="form-group">
          <label>Per√≠odo</label>
          <input type="text" id="periodoEscala" placeholder="Ex: 21/10 a 27/10/2025" required>
        </div>
        <div class="form-group">
          <label>Detalhes da Escala</label>
          <textarea id="conteudoEscala" placeholder="Descreva a escala completa..." required></textarea>
        </div>
        <button type="submit" class="btn">Publicar Escala e Notificar</button>
      </form>
    </div>
    <div class="card">
      <h3>Escalas Publicadas</h3>
      <div id="listaEscalas"></div>
    </div>
  </div>

  <!-- OPERA√á√ïES -->
  <div id="operacoes" class="content-section">
    <div class="card admin-only" id="formOperacao">
      <h3>üìù Nova Opera√ß√£o</h3>
      <form id="operacaoForm">
        <div class="form-group">
          <label>Nome da Opera√ß√£o</label>
          <input type="text" id="nomeOperacao" placeholder="Ex: Opera√ß√£o Centro Seguro" required>
        </div>
        <div class="form-group">
          <label>Data e Hor√°rio</label>
          <input type="datetime-local" id="dataOperacao" required>
        </div>
        <div class="form-group">
          <label>Local</label>
          <input type="text" id="localOperacao" placeholder="Local da opera√ß√£o" required>
        </div>
        <div class="form-group">
          <label>Detalhes</label>
          <textarea id="detalhesOperacao" placeholder="Instru√ß√µes, objetivos..." required></textarea>
        </div>
        <button type="submit" class="btn">Publicar Opera√ß√£o e Notificar</button>
      </form>
    </div>
    <div class="card">
      <h3>Opera√ß√µes Programadas</h3>
      <div id="listaOperacoes"></div>
    </div>
  </div>

  <!-- DOCUMENTOS -->
  <div id="documentos" class="content-section">
    <div class="card admin-only" id="formDocumento">
      <h3>üìù Novo Documento</h3>
      <form id="documentoForm">
        <div class="form-group">
          <label>Categoria</label>
          <select id="categoriaDoc">
            <option>Procedimento Operacional</option>
            <option>Formul√°rio</option>
            <option>Legisla√ß√£o</option>
            <option>Manual</option>
            <option>Outros</option>
          </select>
        </div>
        <div class="form-group">
          <label>Nome do Documento</label>
          <input type="text" id="nomeDoc" placeholder="Ex: Manual de Abordagem 2025" required>
        </div>
        <div class="form-group">
          <label>Descri√ß√£o</label>
          <textarea id="descricaoDoc" placeholder="Breve descri√ß√£o..." required></textarea>
        </div>
        <button type="submit" class="btn">Enviar Documento e Notificar</button>
      </form>
    </div>
    <div class="card">
      <h3>Biblioteca de Documentos</h3>
      <div id="listaDocumentos"></div>
    </div>
  </div>
</div>

<!-- JS -->
<script>
let currentUser = null;

// Login
document.getElementById('loginForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const username = document.getElementById('username').value.toLowerCase();
  const password = document.getElementById('password').value;

  try {
    const userDoc = await db.collection('usuarios').doc(username).get();
    if(userDoc.exists){
      const data = userDoc.data();
      if(data.senha === password){
        currentUser = { username, ...data };
        if(!currentUser.email){
          document.getElementById('emailModal').style.display = 'flex';
        } else showMainSystem();
      } else showLoginError();
    } else showLoginError();
  } catch(err){ console.error(err); showLoginError(); }
});

function showLoginError(){
  const errorMsg = document.getElementById('loginError');
  errorMsg.textContent = '‚ùå Usu√°rio ou senha incorretos';
  errorMsg.style.display = 'block';
}

// Email
document.getElementById('emailForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const email = document.getElementById('userEmail').value;
  currentUser.email = email;
  await db.collection('usuarios').doc(currentUser.username).update({email});
  document.getElementById('emailModal').style.display = 'none';
  showMainSystem();
});

// Mostrar sistema
function showMainSystem(){
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('mainSystem').style.display='block';
  document.getElementById('userBadge').textContent = currentUser.nome;
  if(currentUser.admin){
    document.getElementById('adminBadge').style.display='inline-block';
    document.querySelectorAll('.admin-only').forEach(el=>el.style.display='block');
  }
  loadAllData();
}

// Logout
function logout(){
  currentUser = null;
  document.getElementById('loginScreen').style.display='flex';
  document.getElementById('mainSystem').style.display='none';
  document.getElementById('loginForm').reset();
}

// Tabs
function showTab(tabId, event){
  document.querySelectorAll('.content-section').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el=>el.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  event.currentTarget.classList.add('active');
}

// Carregar dados
async function loadAllData(){
  loadComunicados();
  loadEscalas();
  loadOperacoes();
  loadDocumentos();
}

// Fun√ß√µes Firebase para cada se√ß√£o
async function loadComunicados(){
  const lista = document.getElementById('listaComunicados');
  lista.innerHTML='';
  const snapshot = await db.collection('comunicados').orderBy('data','desc').get();
  snapshot.forEach(doc=>{
    const c = doc.data();
    lista.innerHTML += `
      <div class="item-box">
        <div class="item-header">
          <span class="item-tipo">${c.tipo}</span>
          <span class="item-data">${new Date(c.data).toLocaleString('pt-BR')}</span>
        </div>
        <div class="item-titulo">${c.titulo}</div>
        <div class="item-conteudo">${c.conteudo}</div>
        <div style="margin-top:10px; font-size:12px; color:#999;">Publicado por: ${c.autor}</div>
      </div>
    `;
  });
}

// Escalas, Opera√ß√µes e Documentos seguem mesmo padr√£o
async function loadEscalas(){
  const lista = document.getElementById('listaEscalas');
  lista.innerHTML='';
  const snapshot = await db.collection('escalas').orderBy('data','desc').get();
  snapshot.forEach(doc=>{
    const e = doc.data();
    lista.innerHTML += `
      <div class="item-box">
        <div class="item-header">
          <span class="item-tipo">ESCALA</span>
          <span class="item-data">${new Date(e.data).toLocaleDateString('pt-BR')}</span>
        </div>
        <div class="item-titulo">Per√≠odo: ${e.periodo}</div>
        <div class="item-conteudo">${e.conteudo}</div>
        <div style="margin-top:10px; font-size:12px; color:#999;">Publicado por: ${e.autor}</div>
      </div>
    `;
  });
}

async function loadOperacoes(){
  const lista = document.getElementById('listaOperacoes');
  lista.innerHTML='';
  const snapshot = await db.collection('operacoes').orderBy('data','desc').get();
  snapshot.forEach(doc=>{
    const o = doc.data();
    lista.innerHTML += `
      <div class="item-box">
        <div class="item-header">
          <span class="item-tipo">OPERA√á√ÉO</span>
          <span class="item-data">${new Date(o.data).toLocaleString('pt-BR')}</span>
        </div>
        <div class="item-titulo">${o.nome}</div>
        <div class="item-conteudo"><strong>Local:</strong> ${o.local}<br><strong>Detalhes:</strong> ${o.detalhes}</div>
        <div style="margin-top:10px; font-size:12px; color:#999;">Publicado por: ${o.autor}</div>
      </div>
    `;
  });
}

async function loadDocumentos(){
  const lista = document.getElementById('listaDocumentos');
  lista.innerHTML='';
  const snapshot = await db.collection('documentos').orderBy('data','desc').get();
  snapshot.forEach(doc=>{
    const d = doc.data();
    lista.innerHTML += `
      <div class="item-box">
        <div class="item-header">
          <span class="item-tipo">${d.categoria}</span>
          <span class="item-data">${new Date(d.data).toLocaleDateString('pt-BR')}</span>
        </div>
        <div class="item-titulo">${d.nome}</div>
        <div class="item-conteudo">${d.descricao}</div>
      </div>
    `;
  });
}

// Formul√°rios de adi√ß√£o
document.getElementById('comunicadoForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const tipo = document.getElementById('tipoComunicado').value;
  const titulo = document.getElementById('tituloComunicado').value;
  const conteudo = document.getElementById('conteudoComunicado').value;
  await db.collection('comunicados').add({
    tipo, titulo, conteudo, autor: currentUser.nome, data: new Date().toISOString()
  });
  e.target.reset(); loadComunicados(); alert('‚úÖ Comunicado publicado!');
});

document.getElementById('escalaForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const periodo = document.getElementById('periodoEscala').value;
  const conteudo = document.getElementById('conteudoEscala').value;
  await db.collection('escalas').add({
    periodo, conteudo, autor: currentUser.nome, data: new Date().toISOString()
  });
  e.target.reset(); loadEscalas(); alert('‚úÖ Escala publicada!');
});

document.getElementById('operacaoForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const nome = document.getElementById('nomeOperacao').value;
  const data = document.getElementById('dataOperacao').value;
  const local = document.getElementById('localOperacao').value;
  const detalhes = document.getElementById('detalhesOperacao').value;
  await db.collection('operacoes').add({
    nome, local, detalhes, autor: currentUser.nome, data: new Date(data).toISOString()
  });
  e.target.reset(); loadOperacoes(); alert('‚úÖ Opera√ß√£o publicada!');
});

document.getElementById('documentoForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const categoria = document.getElementById('categoriaDoc').value;
  const nome = document.getElementById('nomeDoc').value;
  const descricao = document.getElementById('descricaoDoc').value;
  await db.collection('documentos').add({
    categoria, nome, descricao, autor: currentUser.nome, data: new Date().toISOString()
  });
  e.target.reset();
